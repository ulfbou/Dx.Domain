name: Integration CI

# Full build with reproducible flags, integration tests, and artifact creation
# Runs on main branch merges

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: integration-ci-${{ github.ref }}
  cancel-in-progress: false

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  SOLUTION: Dx.Domain.sln
  ARTIFACTS_PATH: ./artifacts

jobs:
  build:
    name: Build & Package
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write
    
    outputs:
      version: ${{ steps.gitversion.outputs.semVer }}
      nuget-version: ${{ steps.gitversion.outputs.nuGetVersionV2 }}
      commit-sha: ${{ steps.metadata.outputs.commit-sha }}
      build-id: ${{ steps.metadata.outputs.build-id }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for GitVersion
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x
      
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v1.1.1
        with:
          versionSpec: '5.x'
      
      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1.1.1
        with:
          useConfigFile: true
          configFilePath: .github/GitVersion.yml
      
      - name: Build metadata
        id: metadata
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          BUILD_ID="${{ github.run_id }}-${{ github.run_attempt }}"
          BUILD_TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
          
          echo "commit-sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "build-id=${BUILD_ID}" >> $GITHUB_OUTPUT
          echo "build-timestamp=${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          
          echo "üì¶ Version: ${{ steps.gitversion.outputs.semVer }}"
          echo "üè∑Ô∏è  NuGet Version: ${{ steps.gitversion.outputs.nuGetVersionV2 }}"
          echo "üìù Commit: ${COMMIT_SHA}"
          echo "üî® Build ID: ${BUILD_ID}"
      
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION }}
        working-directory: ./Dx.Domain.2
      
      - name: Build with reproducible flags
        run: |
          dotnet build ${{ env.SOLUTION }} \
            --no-restore \
            --configuration Release \
            -p:ContinuousIntegrationBuild=true \
            -p:Deterministic=true \
            -p:EmbedUntrackedSources=true \
            -p:Version="${{ steps.gitversion.outputs.nuGetVersionV2 }}" \
            -p:AssemblyVersion="${{ steps.gitversion.outputs.assemblySemVer }}" \
            -p:FileVersion="${{ steps.gitversion.outputs.assemblySemFileVer }}" \
            -p:InformationalVersion="${{ steps.gitversion.outputs.informationalVersion }}+${{ steps.metadata.outputs.commit-sha }}"
        working-directory: ./Dx.Domain.2
      
      - name: Run all tests
        run: |
          dotnet test ${{ env.SOLUTION }} \
            --no-build \
            --configuration Release \
            --logger "trx;LogFileName=test-results.trx" \
            --logger "console;verbosity=minimal" \
            --results-directory ./TestResults \
            --collect:"XPlat Code Coverage" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: ./Dx.Domain.2
      
      - name: Generate coverage report
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          reportgenerator \
            -reports:"./Dx.Domain.2/TestResults/**/coverage.opencover.xml" \
            -targetdir:"./Dx.Domain.2/TestResults/CoverageReport" \
            -reporttypes:"HtmlInline_AzurePipelines;Cobertura;Badges"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ./Dx.Domain.2/TestResults/
      
      - name: Create packages
        run: |
          mkdir -p ${{ env.ARTIFACTS_PATH }}
          
          # Find all packable projects
          for project in $(find ./Dx.Domain.2/src -name "*.csproj" -exec grep -l "<IsPackable>true</IsPackable>" {} +); do
            echo "üì¶ Packing: $project"
            dotnet pack "$project" \
              --no-build \
              --configuration Release \
              --output ${{ env.ARTIFACTS_PATH }} \
              -p:PackageVersion="${{ steps.gitversion.outputs.nuGetVersionV2 }}" \
              -p:RepositoryCommit="${{ github.sha }}" \
              -p:RepositoryUrl="https://github.com/${{ github.repository }}" \
              -p:RepositoryBranch="${{ github.ref_name }}" \
              -p:BuildId="${{ steps.metadata.outputs.build-id }}" \
              --include-symbols \
              -p:SymbolPackageFormat=snupkg
          done
      
      - name: List artifacts
        run: |
          echo "üì¶ Created artifacts:"
          ls -lh ${{ env.ARTIFACTS_PATH }}
      
      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ${{ env.ARTIFACTS_PATH }}/*.nupkg
          retention-days: 90
      
      - name: Upload symbols
        uses: actions/upload-artifact@v4
        with:
          name: nuget-symbols
          path: ${{ env.ARTIFACTS_PATH }}/*.snupkg
          retention-days: 90
      
      - name: Generate SBOM
        run: |
          dotnet tool install --global Microsoft.Sbom.DotNetTool
          sbom-tool generate \
            -b ${{ env.ARTIFACTS_PATH }} \
            -bc ./Dx.Domain.2 \
            -pn "Dx.Domain" \
            -pv "${{ steps.gitversion.outputs.semVer }}" \
            -ps "ulfbou" \
            -nsb "https://github.com/ulfbou/Notes"
      
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: ${{ env.ARTIFACTS_PATH }}/_manifest/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      
      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION }}
        working-directory: ./Dx.Domain.2
      
      - name: Build
        run: dotnet build ${{ env.SOLUTION }} --no-restore --configuration Release
        working-directory: ./Dx.Domain.2
      
      - name: Run integration tests
        run: |
          dotnet test ${{ env.SOLUTION }} \
            --no-build \
            --configuration Release \
            --filter "Category=Integration" \
            --logger "trx;LogFileName=integration-test-results.trx" \
            --results-directory ./IntegrationTestResults
        working-directory: ./Dx.Domain.2
      
      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: ./Dx.Domain.2/IntegrationTestResults/

  publish-preview:
    name: Publish Preview Packages
    runs-on: ubuntu-latest
    needs: [build, integration-tests]
    if: github.ref == 'refs/heads/develop'
    permissions:
      packages: write
    
    steps:
      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./packages
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      
      - name: Publish to GitHub Packages
        run: |
          for package in ./packages/*.nupkg; do
            echo "üì§ Publishing: $package"
            dotnet nuget push "$package" \
              --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
              --api-key "${{ secrets.GITHUB_TOKEN }}" \
              --skip-duplicate
          done

  status-check:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [build, integration-tests]
    if: always()
    
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "::error::Build failed"
            exit 1
          fi
          if [ "${{ needs.integration-tests.result }}" == "failure" ]; then
            echo "::error::Integration tests failed"
            exit 1
          fi
          echo "‚úÖ Integration CI completed successfully"
          echo "üì¶ Version: ${{ needs.build.outputs.version }}"
          echo "üè∑Ô∏è  NuGet Version: ${{ needs.build.outputs.nuget-version }}"
